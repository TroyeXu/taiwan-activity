# 篩選機制優化設計文件

## 1. 篩選系統概述

### 1.1 設計目標
- 提供直觀易用的篩選介面
- 支援多維度快速篩選
- 即時顯示篩選結果
- 智慧推薦相關活動

### 1.2 核心原則
- **漸進式揭露**：從簡單到複雜的篩選選項
- **即時回饋**：篩選結果即時更新
- **狀態保持**：記住使用者篩選偏好
- **視覺化提示**：清楚顯示已選條件和結果數量

## 2. 篩選維度定義

### 2.1 主要篩選維度

#### 2.1.1 活動類型（必選維度）
```javascript
const activityCategories = [
  {
    id: 'traditional',
    name: '傳統節慶',
    icon: '🎊',
    color: '#DC2626',
    keywords: ['節慶', '廟會', '民俗', '傳統', '文化']
  },
  {
    id: 'romantic',
    name: '浪漫之旅',
    icon: '💕',
    color: '#EC4899',
    keywords: ['情侶', '約會', '浪漫', '夜景', '咖啡']
  },
  {
    id: 'art_culture',
    name: '藝術文化',
    icon: '🎭',
    color: '#7C3AED',
    keywords: ['展覽', '藝術', '文化', '博物館', '表演']
  },
  {
    id: 'wellness',
    name: '養生樂活',
    icon: '🧘',
    color: '#10B981',
    keywords: ['健康', '瑜伽', '按摩', '溫泉', '運動']
  },
  {
    id: 'cuisine',
    name: '美食饗宴',
    icon: '🍜',
    color: '#F59E0B',
    keywords: ['美食', '餐廳', '小吃', '夜市', '料理']
  },
  {
    id: 'nature',
    name: '自然生態',
    icon: '🌿',
    color: '#059669',
    keywords: ['自然', '生態', '登山', '海邊', '公園']
  },
  {
    id: 'indigenous',
    name: '原民慶典',
    icon: '🪶',
    color: '#B91C1C',
    keywords: ['原住民', '部落', '慶典', '傳統', '文化']
  },
  {
    id: 'hakka',
    name: '客家文化',
    icon: '🏮',
    color: '#1E40AF',
    keywords: ['客家', '文化', '傳統', '節慶', '美食']
  }
];
```

#### 2.1.2 地區篩選（支援多層級）
```javascript
const regions = {
  north: {
    name: '北部地區',
    cities: [
      { id: 'taipei', name: '台北市', districts: ['中正區', '大同區', '中山區', '松山區', '大安區', '萬華區', '信義區', '士林區', '北投區', '內湖區', '南港區', '文山區'] },
      { id: 'new_taipei', name: '新北市', districts: ['板橋區', '三重區', '中和區', '永和區', '新莊區', '新店區', '樹林區', '鶯歌區', '三峽區', '淡水區'] },
      { id: 'keelung', name: '基隆市' },
      { id: 'taoyuan', name: '桃園市' },
      { id: 'hsinchu_city', name: '新竹市' },
      { id: 'hsinchu_county', name: '新竹縣' }
    ]
  },
  central: {
    name: '中部地區',
    cities: [
      { id: 'miaoli', name: '苗栗縣' },
      { id: 'taichung', name: '台中市' },
      { id: 'changhua', name: '彰化縣' },
      { id: 'nantou', name: '南投縣' },
      { id: 'yunlin', name: '雲林縣' }
    ]
  },
  south: {
    name: '南部地區',
    cities: [
      { id: 'chiayi_county', name: '嘉義縣' },
      { id: 'chiayi_city', name: '嘉義市' },
      { id: 'tainan', name: '台南市' },
      { id: 'kaohsiung', name: '高雄市' },
      { id: 'pingtung', name: '屏東縣' }
    ]
  },
  east: {
    name: '東部地區',
    cities: [
      { id: 'yilan', name: '宜蘭縣' },
      { id: 'hualien', name: '花蓮縣' },
      { id: 'taitung', name: '台東縣' }
    ]
  },
  islands: {
    name: '離島地區',
    cities: [
      { id: 'penghu', name: '澎湖縣' },
      { id: 'kinmen', name: '金門縣' },
      { id: 'lienchiang', name: '連江縣' }
    ]
  }
};
```

#### 2.1.3 時間篩選
```javascript
const timeFilters = {
  // 快速選項
  quick: [
    { id: 'today', name: '今天', value: 0 },
    { id: 'tomorrow', name: '明天', value: 1 },
    { id: 'this_week', name: '本週', value: 'week' },
    { id: 'this_weekend', name: '本週末', value: 'weekend' },
    { id: 'next_week', name: '下週', value: 'next_week' },
    { id: 'this_month', name: '本月', value: 'month' }
  ],
  
  // 自訂日期範圍
  custom: {
    startDate: null,
    endDate: null,
    includeOngoing: true  // 包含進行中的活動
  },
  
  // 時段篩選
  timeOfDay: [
    { id: 'morning', name: '上午 (06:00-12:00)', start: '06:00', end: '12:00' },
    { id: 'afternoon', name: '下午 (12:00-18:00)', start: '12:00', end: '18:00' },
    { id: 'evening', name: '晚上 (18:00-24:00)', start: '18:00', end: '24:00' }
  ]
};
```

### 2.2 進階篩選維度

#### 2.2.1 距離與位置
```javascript
const locationFilters = {
  // 距離篩選
  distance: [
    { id: 'nearby', name: '附近 (2km)', radius: 2000 },
    { id: 'walking', name: '步行可達 (5km)', radius: 5000 },
    { id: 'cycling', name: '騎車可達 (10km)', radius: 10000 },
    { id: 'driving', name: '開車可達 (30km)', radius: 30000 },
    { id: 'unlimited', name: '不限距離', radius: null }
  ],
  
  // 交通便利性
  transportation: [
    { id: 'mrt_accessible', name: '捷運可達' },
    { id: 'bus_accessible', name: '公車可達' },
    { id: 'parking_available', name: '有停車場' },
    { id: 'bike_friendly', name: '自行車友善' }
  ]
};
```

#### 2.2.2 活動特性
```javascript
const activityFeatures = {
  // 參與方式
  participation: [
    { id: 'free', name: '免費活動', icon: '🆓' },
    { id: 'paid', name: '付費活動', icon: '💰' },
    { id: 'registration_required', name: '需要報名', icon: '📝' },
    { id: 'walk_in', name: '自由參加', icon: '🚶' }
  ],
  
  // 適合對象
  suitableFor: [
    { id: 'family', name: '親子活動', icon: '👨‍👩‍👧‍👦' },
    { id: 'couples', name: '情侶約會', icon: '💑' },
    { id: 'seniors', name: '銀髮族', icon: '👴' },
    { id: 'youth', name: '青少年', icon: '👦' },
    { id: 'solo', name: '個人參與', icon: '🙋' }
  ],
  
  // 活動規模
  scale: [
    { id: 'intimate', name: '小型聚會 (<50人)', max: 50 },
    { id: 'medium', name: '中型活動 (50-500人)', min: 50, max: 500 },
    { id: 'large', name: '大型活動 (>500人)', min: 500 }
  ]
};
```

## 3. 篩選介面設計

### 3.1 桌面版篩選面板

```
┌─────────────────────────────────────┐
│ 篩選條件                     [重置] │
├─────────────────────────────────────┤
│ 📍 位置                             │
│ ○ 使用目前位置   [📍 取得位置]     │
│ ○ 手動選擇       [🔍 搜尋地點]     │
│                                     │
│ 📏 距離範圍                         │
│ ●○○○○ 附近2km                     │
│                                     │
│ 🎭 活動類型                         │
│ ☑️ 傳統節慶  ☑️ 浪漫之旅            │
│ ☑️ 藝術文化  ☐ 養生樂活            │
│ ☐ 美食饗宴  ☐ 自然生態            │
│ ☐ 原民慶典  ☐ 客家文化            │
│ [全選] [清除]                       │
│                                     │
│ 📅 時間                             │
│ 快速選項：                          │
│ [今天] [明天] [本週末] [本月]       │
│                                     │
│ 自訂日期：                          │
│ 從 [2025/01/22] 到 [2025/01/29]   │
│ ☑️ 包含進行中的活動                 │
│                                     │
│ 🌍 地區 ▼                          │
│ ☑️ 北部地區                         │
│   ☑️ 台北市                         │
│     ☐ 中正區  ☐ 大同區             │
│     ☑️ 信義區  ☐ 松山區             │
│   ☐ 新北市                         │
│   ☐ 桃園市                         │
│                                     │
│ ⚙️ 更多篩選 ▼                       │
│ 💰 費用                             │
│ ☑️ 免費活動  ☐ 付費活動             │
│                                     │
│ 👥 適合對象                         │
│ ☑️ 親子活動  ☐ 情侶約會             │
│                                     │
│ ─────────────────────────────────  │
│ 找到 25 個符合的活動                │
│ [套用篩選]                          │
└─────────────────────────────────────┘
```

### 3.2 手機版篩選介面

```
┌─────────────────────────────┐
│ ◀ 篩選條件            [重置] │
├─────────────────────────────┤
│                             │
│ 📍 位置與距離               │
│ ┌─────────────────────────┐ │
│ │ 🎯 台北市信義區        │ │
│ │ 📏 附近 2 公里          │ │
│ │ [變更位置]             │ │
│ └─────────────────────────┘ │
│                             │
│ 🎭 活動類型（可多選）       │
│ ┌─────────────────────────┐ │
│ │ ☑️🎊 傳統節慶           │ │
│ │ ☑️💕 浪漫之旅           │ │
│ │ ☐🎭 藝術文化           │ │
│ │ ☐🧘 養生樂活           │ │
│ │ ☐🍜 美食饗宴           │ │
│ │ ☐🌿 自然生態           │ │
│ │ ☐🪶 原民慶典           │ │
│ │ ☐🏮 客家文化           │ │
│ └─────────────────────────┘ │
│                             │
│ 📅 時間                     │
│ 快速選項：                  │
│ [今天] [明天] [本週末]      │
│ [自訂日期範圍...]          │
│                             │
│ 🌍 地區                     │
│ [選擇地區...]              │
│                             │
│ ⚙️ 更多篩選                 │
│ [費用] [適合對象] [其他]    │
│                             │
│ ─────────────────────────── │
│ 找到 25 個活動              │
│ ┌─────────────────────────┐ │
│ │     查看結果 (25)        │ │
│ └─────────────────────────┘ │
└─────────────────────────────┘
```

## 4. 篩選邏輯與演算法

### 4.1 篩選權重系統

```javascript
const filterWeights = {
  // 核心篩選（必須滿足）
  core: {
    category: 1.0,        // 活動類型
    location: 1.0,        // 地理位置
    date: 1.0             // 時間範圍
  },
  
  // 偏好篩選（影響排序）
  preference: {
    distance: 0.3,        // 距離偏好
    timeOfDay: 0.2,       // 時段偏好
    features: 0.25,       // 活動特性
    popularity: 0.25      // 受歡迎程度
  }
};
```

### 4.2 智慧推薦演算法

```javascript
class SmartRecommendation {
  // 基於使用者行為的推薦
  getUserBasedRecommendation(userId, currentFilters) {
    const userHistory = this.getUserHistory(userId);
    const preferences = this.analyzePreferences(userHistory);
    
    return this.adjustFilters(currentFilters, preferences);
  }
  
  // 基於地理位置的推薦
  getLocationBasedRecommendation(lat, lng, radius) {
    const nearbyPopular = this.getPopularActivitiesNearby(lat, lng, radius);
    const seasonalEvents = this.getSeasonalEvents();
    
    return this.combineRecommendations(nearbyPopular, seasonalEvents);
  }
  
  // 基於時間的推薦
  getTimeBasedRecommendation(date, timeOfDay) {
    const upcomingEvents = this.getUpcomingEvents(date);
    const timeAppropriate = this.filterByTimeOfDay(upcomingEvents, timeOfDay);
    
    return timeAppropriate.sort((a, b) => b.relevanceScore - a.relevanceScore);
  }
}
```

### 4.3 結果排序策略

```javascript
const sortingStrategies = {
  relevance: {
    name: '最相關',
    algorithm: (activities, filters, userContext) => {
      return activities.map(activity => ({
        ...activity,
        score: this.calculateRelevanceScore(activity, filters, userContext)
      })).sort((a, b) => b.score - a.score);
    }
  },
  
  distance: {
    name: '距離最近',
    algorithm: (activities, userLocation) => {
      return activities.sort((a, b) => 
        this.calculateDistance(a.location, userLocation) - 
        this.calculateDistance(b.location, userLocation)
      );
    }
  },
  
  popularity: {
    name: '最受歡迎',
    algorithm: (activities) => {
      return activities.sort((a, b) => 
        (b.viewCount + b.favoriteCount) - (a.viewCount + a.favoriteCount)
      );
    }
  },
  
  date: {
    name: '時間最近',
    algorithm: (activities) => {
      const now = new Date();
      return activities.sort((a, b) => 
        Math.abs(new Date(a.startDate) - now) - 
        Math.abs(new Date(b.startDate) - now)
      );
    }
  }
};
```

## 5. 篩選狀態管理

### 5.1 篩選狀態結構

```typescript
interface FilterState {
  // 基本篩選
  categories: string[];
  regions: {
    [regionId: string]: {
      selected: boolean;
      cities: {
        [cityId: string]: {
          selected: boolean;
          districts?: string[];
        };
      };
    };
  };
  dateRange: {
    type: 'quick' | 'custom';
    quickOption?: string;
    startDate?: Date;
    endDate?: Date;
    includeOngoing: boolean;
  };
  
  // 位置篩選
  location: {
    type: 'current' | 'custom';
    coordinates?: { lat: number; lng: number };
    address?: string;
    radius: number;
  };
  
  // 進階篩選
  advanced: {
    features: string[];
    priceRange: { min: number; max: number };
    suitableFor: string[];
    transportation: string[];
  };
  
  // 顯示設定
  sorting: 'relevance' | 'distance' | 'popularity' | 'date';
  resultLimit: number;
  
  // 元資料
  metadata: {
    lastUpdated: Date;
    resultCount: number;
    searchId: string;
  };
}
```

### 5.2 篩選狀態持久化

```javascript
class FilterStateManager {
  // 儲存篩選狀態
  saveState(filters) {
    const state = {
      ...filters,
      timestamp: Date.now(),
      version: FILTER_VERSION
    };
    
    // 儲存到本地儲存
    localStorage.setItem('tourismFilters', JSON.stringify(state));
    
    // 如果使用者已登入，同步到伺服器
    if (this.isUserLoggedIn()) {
      this.syncToServer(state);
    }
  }
  
  // 載入篩選狀態
  loadState() {
    const saved = localStorage.getItem('tourismFilters');
    if (saved) {
      const state = JSON.parse(saved);
      
      // 檢查版本相容性
      if (state.version === FILTER_VERSION) {
        return this.validateState(state);
      }
    }
    
    return this.getDefaultState();
  }
  
  // 合併使用者偏好
  mergeUserPreferences(baseFilters, userPreferences) {
    return {
      ...baseFilters,
      categories: userPreferences.preferredCategories || baseFilters.categories,
      location: {
        ...baseFilters.location,
        radius: userPreferences.preferredRadius || baseFilters.location.radius
      },
      sorting: userPreferences.preferredSorting || baseFilters.sorting
    };
  }
}
```

## 6. 效能優化

### 6.1 篩選結果快取

```javascript
class FilterCache {
  constructor() {
    this.cache = new Map();
    this.maxCacheSize = 100;
    this.cacheTTL = 5 * 60 * 1000; // 5 分鐘
  }
  
  // 產生快取鍵
  generateCacheKey(filters) {
    const normalized = this.normalizeFilters(filters);
    return btoa(JSON.stringify(normalized));
  }
  
  // 取得快取結果
  get(filters) {
    const key = this.generateCacheKey(filters);
    const cached = this.cache.get(key);
    
    if (cached && (Date.now() - cached.timestamp) < this.cacheTTL) {
      return cached.data;
    }
    
    return null;
  }
  
  // 儲存快取結果
  set(filters, results) {
    const key = this.generateCacheKey(filters);
    
    // 清理過期快取
    if (this.cache.size >= this.maxCacheSize) {
      this.cleanExpiredCache();
    }
    
    this.cache.set(key, {
      data: results,
      timestamp: Date.now()
    });
  }
}
```

### 6.2 即時搜尋優化

```javascript
class RealTimeFilter {
  constructor() {
    this.debounceTime = 300;
    this.pendingRequest = null;
  }
  
  // 防抖動搜尋
  search(filters, callback) {
    // 取消之前的請求
    if (this.pendingRequest) {
      clearTimeout(this.pendingRequest);
    }
    
    // 延遲執行搜尋
    this.pendingRequest = setTimeout(async () => {
      try {
        const results = await this.performSearch(filters);
        callback(null, results);
      } catch (error) {
        callback(error, null);
      }
    }, this.debounceTime);
  }
  
  // 漸進式載入結果
  async loadResults(filters, page = 1, limit = 20) {
    const offset = (page - 1) * limit;
    
    const response = await fetch('/api/activities/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        filters,
        pagination: { offset, limit }
      })
    });
    
    return await response.json();
  }
}
```

## 7. 使用者體驗優化

### 7.1 篩選提示與引導

```javascript
const filterGuidance = {
  // 首次使用引導
  firstTimeUser: {
    steps: [
      {
        target: '.category-filter',
        title: '選擇你感興趣的活動類型',
        description: '可以選擇多個類型來發現更多精彩活動'
      },
      {
        target: '.location-filter',
        title: '設定你的位置',
        description: '讓我們為你推薦附近的活動'
      },
      {
        target: '.date-filter',
        title: '選擇時間範圍',
        description: '可以用快速選項或自訂日期'
      }
    ]
  },
  
  // 智慧建議
  suggestions: {
    noResults: [
      '試試擴大搜尋範圍',
      '選擇更多活動類型',
      '調整時間範圍',
      '考慮附近的其他地區'
    ],
    tooManyResults: [
      '縮小地理範圍',
      '選擇特定活動類型',
      '設定更精確的時間'
    ]
  }
};
```

### 7.2 篩選結果預覽

```javascript
class FilterPreview {
  // 即時顯示結果數量
  showResultCount(filters) {
    const estimatedCount = this.estimateResults(filters);
    const preview = document.querySelector('.result-preview');
    
    preview.textContent = `預計找到 ${estimatedCount} 個活動`;
    
    // 如果結果太少，顯示建議
    if (estimatedCount < 5) {
      this.showSuggestions('expand');
    } else if (estimatedCount > 50) {
      this.showSuggestions('narrow');
    }
  }
  
  // 顯示熱門篩選組合
  showPopularCombinations() {
    const popular = [
      { name: '本週末台北藝文活動', filters: { /* ... */ } },
      { name: '免費親子活動', filters: { /* ... */ } },
      { name: '浪漫約會景點', filters: { /* ... */ } }
    ];
    
    return popular;
  }
}
```

這份篩選機制優化設計提供了完整的篩選功能規劃，確保使用者能夠快速找到感興趣的觀光活動。