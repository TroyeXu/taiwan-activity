# 觀光活動地圖系統架構圖

## 1. 整體系統架構

```mermaid
graph TB
    subgraph "前端層 Frontend"
        A[Web Application<br/>React/Vue.js]
        B[Mobile Web]
    end
    
    subgraph "API 閘道層"
        C[API Gateway<br/>Kong/Nginx]
    end
    
    subgraph "應用服務層"
        D[Activity Service<br/>活動管理服務]
        E[Map Service<br/>地圖服務]
        F[Search Service<br/>搜尋服務]
        G[User Service<br/>使用者服務]
    end
    
    subgraph "資料驗證層"
        H[Claude Code<br/>Validation Service<br/>資料驗證服務]
    end
    
    subgraph "資料收集層"
        I[Web Crawler 1<br/>網站爬蟲 1]
        J[Web Crawler 2<br/>網站爬蟲 2]
        K[Web Crawler N<br/>網站爬蟲 N]
    end
    
    subgraph "資料儲存層"
        L[(PostgreSQL<br/>主資料庫)]
        M[(Redis<br/>快取資料庫)]
        N[(Elasticsearch<br/>搜尋引擎)]
        O[(S3/MinIO<br/>物件儲存)]
    end
    
    subgraph "外部服務"
        P[Google Maps API]
        Q[Geocoding API]
    end
    
    A --> C
    B --> C
    C --> D
    C --> E
    C --> F
    C --> G
    
    D --> L
    D --> M
    E --> P
    E --> Q
    F --> N
    G --> L
    
    I --> H
    J --> H
    K --> H
    
    H --> L
    H --> O
    
    D --> H
```

## 2. 資料處理流程圖

```mermaid
flowchart LR
    subgraph "資料來源"
        A1[觀光局網站]
        A2[地方政府網站]
        A3[活動平台]
    end
    
    subgraph "爬蟲系統"
        B1[Scrapy Spider 1]
        B2[Scrapy Spider 2]
        B3[Scrapy Spider 3]
    end
    
    subgraph "暫存區"
        C[(Raw Data Queue<br/>原始資料佇列)]
    end
    
    subgraph "Claude Code 驗證"
        D1[格式檢查]
        D2[內容驗證]
        D3[重複檢測]
        D4[品質評分]
    end
    
    subgraph "資料處理"
        E1[格式標準化]
        E2[地理編碼]
        E3[分類處理]
    end
    
    subgraph "儲存系統"
        F1[(活動資料庫)]
        F2[(驗證日誌)]
        F3[(搜尋索引)]
    end
    
    A1 --> B1
    A2 --> B2
    A3 --> B3
    
    B1 --> C
    B2 --> C
    B3 --> C
    
    C --> D1
    D1 --> D2
    D2 --> D3
    D3 --> D4
    
    D4 -->|通過| E1
    D4 -->|失敗| F2
    
    E1 --> E2
    E2 --> E3
    
    E3 --> F1
    E3 --> F3
```

## 3. 使用者互動流程圖

```mermaid
sequenceDiagram
    participant U as 使用者
    participant W as Web App
    participant API as API Gateway
    participant AS as Activity Service
    participant MS as Map Service
    participant DB as Database
    participant GM as Google Maps
    
    U->>W: 開啟網站
    W->>W: 請求定位權限
    U->>W: 允許定位
    W->>GM: 取得當前位置
    GM-->>W: 回傳座標
    
    U->>W: 設定篩選條件
    W->>API: 搜尋請求
    API->>AS: 查詢活動
    AS->>DB: SQL 查詢
    DB-->>AS: 活動資料
    AS-->>API: 活動列表
    API-->>W: JSON 回應
    
    W->>MS: 請求地圖標記
    MS->>GM: 建立標記
    GM-->>W: 顯示地圖
    
    U->>W: 點擊標記
    W->>API: 取得詳情
    API->>AS: 查詢單一活動
    AS->>DB: 查詢詳情
    DB-->>AS: 完整資料
    AS-->>API: 活動詳情
    API-->>W: 顯示詳情
```

## 4. Claude Code 驗證服務架構

```mermaid
flowchart TB
    subgraph "輸入層"
        A[爬蟲資料輸入]
        B[API 資料輸入]
        C[手動資料輸入]
    end
    
    subgraph "驗證引擎"
        D[資料接收器]
        E[驗證規則引擎]
        F[Claude AI 分析]
        G[結果處理器]
    end
    
    subgraph "驗證規則"
        H[必填欄位檢查]
        I[格式驗證]
        J[邏輯驗證]
        K[真實性驗證]
    end
    
    subgraph "輸出層"
        L[驗證通過<br/>標準化資料]
        M[驗證失敗<br/>錯誤報告]
        N[需人工審核<br/>待處理清單]
    end
    
    A --> D
    B --> D
    C --> D
    
    D --> E
    E --> H
    E --> I
    E --> J
    E --> K
    
    H --> F
    I --> F
    J --> F
    K --> F
    
    F --> G
    
    G --> L
    G --> M
    G --> N
```

## 5. 資料庫架構圖

```mermaid
erDiagram
    ACTIVITIES ||--o{ ACTIVITY_CATEGORIES : has
    ACTIVITIES ||--|| LOCATIONS : has
    ACTIVITIES ||--|| DATA_SOURCES : from
    CATEGORIES ||--o{ ACTIVITY_CATEGORIES : contains
    ACTIVITIES ||--o{ VALIDATION_LOGS : validated
    USERS ||--o{ USER_FAVORITES : saves
    ACTIVITIES ||--o{ USER_FAVORITES : saved
    
    ACTIVITIES {
        string id PK
        string name
        text description
        datetime start_date
        datetime end_date
        string status
        json contact_info
        datetime created_at
        datetime updated_at
    }
    
    LOCATIONS {
        string id PK
        string activity_id FK
        string address
        string district
        string city
        string region
        decimal latitude
        decimal longitude
    }
    
    CATEGORIES {
        string id PK
        string name
        string slug
        string color_code
    }
    
    ACTIVITY_CATEGORIES {
        string activity_id FK
        string category_id FK
    }
    
    DATA_SOURCES {
        string id PK
        string source_name
        string source_url
        datetime crawled_at
        boolean is_verified
    }
    
    VALIDATION_LOGS {
        string id PK
        string activity_id FK
        json original_data
        json validated_data
        decimal quality_score
        string status
        datetime validated_at
    }
    
    USERS {
        string id PK
        string email
        string name
        datetime created_at
    }
    
    USER_FAVORITES {
        string user_id FK
        string activity_id FK
        datetime saved_at
    }
```

## 6. 部署架構圖

```mermaid
graph TB
    subgraph "使用者端"
        A[Desktop Browser]
        B[Mobile Browser]
    end
    
    subgraph "CDN Layer"
        C[CloudFlare CDN]
    end
    
    subgraph "Load Balancer"
        D[AWS ALB / Nginx]
    end
    
    subgraph "Application Servers"
        E[Node.js Server 1]
        F[Node.js Server 2]
        G[Node.js Server N]
    end
    
    subgraph "Worker Servers"
        H[Crawler Worker 1]
        I[Crawler Worker 2]
        J[Validation Worker]
    end
    
    subgraph "Database Cluster"
        K[(Primary DB)]
        L[(Read Replica 1)]
        M[(Read Replica 2)]
    end
    
    subgraph "Cache Layer"
        N[Redis Cluster]
    end
    
    subgraph "Search Cluster"
        O[Elasticsearch Node 1]
        P[Elasticsearch Node 2]
    end
    
    A --> C
    B --> C
    C --> D
    D --> E
    D --> F
    D --> G
    
    E --> K
    E --> L
    E --> M
    E --> N
    F --> K
    F --> L
    F --> M
    F --> N
    G --> K
    G --> L
    G --> M
    G --> N
    
    E --> O
    E --> P
    F --> O
    F --> P
    G --> O
    G --> P
    
    H --> J
    I --> J
    J --> K
```

## 7. 監控與日誌架構

```mermaid
flowchart LR
    subgraph "應用層"
        A[Web Servers]
        B[API Servers]
        C[Worker Servers]
    end
    
    subgraph "收集層"
        D[Fluentd/Logstash]
        E[Prometheus]
        F[APM Agent]
    end
    
    subgraph "儲存層"
        G[(Elasticsearch<br/>日誌儲存)]
        H[(InfluxDB<br/>指標儲存)]
        I[APM Server]
    end
    
    subgraph "視覺化層"
        J[Kibana<br/>日誌分析]
        K[Grafana<br/>指標監控]
        L[APM Dashboard]
    end
    
    subgraph "告警系統"
        M[AlertManager]
        N[PagerDuty]
        O[Slack]
    end
    
    A --> D
    A --> E
    A --> F
    B --> D
    B --> E
    B --> F
    C --> D
    C --> E
    C --> F
    
    D --> G
    E --> H
    F --> I
    
    G --> J
    H --> K
    I --> L
    
    K --> M
    J --> M
    L --> M
    
    M --> N
    M --> O
```

這些架構圖涵蓋了整個系統的各個層面，從整體架構到具體的資料流程、使用者互動、資料庫設計和部署方案。每個圖表都使用 Mermaid 語法，可以在支援 Markdown 的環境中直接渲染顯示。