# 技術實作計畫

## 1. 技術堆疊選型

### 1.1 前端技術

```yaml
框架: React 18 + TypeScript
狀態管理: Zustand
路由: React Router v6
UI 框架: Tailwind CSS + Headless UI
地圖: Google Maps JavaScript API
打包工具: Vite
測試: Jest + React Testing Library
```

### 1.2 後端技術 

```yaml
運行環境: Node.js 20 LTS
框架: Express.js + TypeScript
API 規範: RESTful + GraphQL (部分功能)
驗證中介: Claude Code Integration
資料庫: PostgreSQL 15 + Redis
ORM: Prisma
佇列: Bull (Redis-based)
測試: Jest + Supertest
```

### 1.3 資料收集與驗證

```yaml
爬蟲框架: Python Scrapy
排程: Apache Airflow
驗證服務: Claude Code API
資料處理: Pandas
地理編碼: Google Geocoding API
```

### 1.4 基礎設施

```yaml
容器化: Docker + Docker Compose
反向代理: Nginx
CI/CD: GitHub Actions
監控: Prometheus + Grafana
日誌: ELK Stack
雲端服務: AWS / GCP
```

## 2. 專案結構

### 2.1 整體專案結構

```
tourism-activity-map/
├── frontend/                 # 前端應用
├── backend/                  # 後端 API
├── crawler/                  # 爬蟲系統
├── validator/               # Claude 驗證服務
├── shared/                  # 共用類型定義
├── infrastructure/          # 基礎設施配置
├── docs/                    # 專案文件
└── docker-compose.yml       # 開發環境配置
```

### 2.2 前端專案結構

```
frontend/
├── src/
│   ├── components/          # UI 元件
│   │   ├── common/         # 共用元件
│   │   ├── map/           # 地圖相關
│   │   ├── activity/      # 活動相關
│   │   └── filters/       # 篩選器
│   ├── pages/             # 頁面元件
│   ├── hooks/             # 自定義 Hooks
│   ├── stores/            # Zustand stores
│   ├── services/          # API 服務
│   ├── utils/             # 工具函數
│   ├── types/             # TypeScript 類型
│   └── styles/            # 全域樣式
├── public/                # 靜態資源
├── tests/                 # 測試檔案
└── package.json
```

### 2.3 後端專案結構

```
backend/
├── src/
│   ├── controllers/       # 控制器
│   ├── services/         # 商業邏輯
│   ├── models/           # 資料模型
│   ├── routes/           # 路由定義
│   ├── middlewares/      # 中介軟體
│   ├── validators/       # 輸入驗證
│   ├── utils/            # 工具函數
│   ├── config/           # 配置檔案
│   └── jobs/             # 背景任務
├── prisma/
│   ├── schema.prisma     # 資料庫模型
│   └── migrations/       # 資料庫遷移
├── tests/                # 測試檔案
└── package.json
```

## 3. 資料庫設計

### 3.1 PostgreSQL Schema

```sql
-- 活動主表
CREATE TABLE activities (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(200) NOT NULL,
    description TEXT,
    summary VARCHAR(100),
    status VARCHAR(20) DEFAULT 'pending',
    quality_score INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    version INTEGER DEFAULT 1
);

-- 地點資訊表
CREATE TABLE locations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    activity_id UUID REFERENCES activities(id) ON DELETE CASCADE,
    address VARCHAR(500) NOT NULL,
    district VARCHAR(50),
    city VARCHAR(50) NOT NULL,
    region VARCHAR(20) NOT NULL,
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    venue VARCHAR(200),
    landmarks TEXT[]
);

-- 時間資訊表
CREATE TABLE activity_times (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    activity_id UUID REFERENCES activities(id) ON DELETE CASCADE,
    start_date DATE NOT NULL,
    end_date DATE,
    start_time TIME,
    end_time TIME,
    duration INTEGER,
    timezone VARCHAR(50) DEFAULT 'Asia/Taipei',
    is_recurring BOOLEAN DEFAULT FALSE,
    recurrence_rule JSONB
);

-- 分類表
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) UNIQUE NOT NULL,
    slug VARCHAR(50) UNIQUE NOT NULL,
    color_code VARCHAR(7),
    icon VARCHAR(50)
);

-- 活動分類關聯表
CREATE TABLE activity_categories (
    activity_id UUID REFERENCES activities(id) ON DELETE CASCADE,
    category_id UUID REFERENCES categories(id) ON DELETE CASCADE,
    PRIMARY KEY (activity_id, category_id)
);

-- 資料來源表
CREATE TABLE data_sources (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    activity_id UUID REFERENCES activities(id) ON DELETE CASCADE,
    website VARCHAR(200) NOT NULL,
    url VARCHAR(500),
    crawled_at TIMESTAMP NOT NULL,
    crawler_version VARCHAR(20)
);

-- 驗證記錄表
CREATE TABLE validation_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    activity_id UUID REFERENCES activities(id) ON DELETE CASCADE,
    original_data JSONB NOT NULL,
    validated_data JSONB,
    quality_score INTEGER,
    issues JSONB,
    suggestions JSONB,
    validated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    validator VARCHAR(50)
);

-- 使用者表
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 使用者收藏表
CREATE TABLE user_favorites (
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    activity_id UUID REFERENCES activities(id) ON DELETE CASCADE,
    saved_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, activity_id)
);

-- 建立索引
CREATE INDEX idx_activities_status ON activities(status);
CREATE INDEX idx_activities_quality_score ON activities(quality_score);
CREATE INDEX idx_locations_city_region ON locations(city, region);
CREATE INDEX idx_locations_coordinates ON locations(latitude, longitude);
CREATE INDEX idx_activity_times_dates ON activity_times(start_date, end_date);
CREATE INDEX idx_validation_logs_activity ON validation_logs(activity_id);
```

### 3.2 Redis 資料結構

```javascript
// 快取鍵設計
const cacheKeys = {
  // 活動快取
  activity: (id) => `activity:${id}`,
  activityList: (filters) => `activities:${JSON.stringify(filters)}`,
  
  // 地理位置快取
  nearbyActivities: (lat, lng, radius) => `nearby:${lat}:${lng}:${radius}`,
  geocoding: (address) => `geocode:${address}`,
  
  // 統計快取
  categoryCount: (category) => `stats:category:${category}`,
  regionCount: (region) => `stats:region:${region}`,
  
  // 驗證佇列
  validationQueue: 'queue:validation',
  crawlerQueue: 'queue:crawler',
  
  // Session
  userSession: (userId) => `session:${userId}`
};
```

## 4. API 設計

### 4.1 RESTful API 端點

```yaml
# 活動相關
GET    /api/v1/activities              # 取得活動列表
GET    /api/v1/activities/:id          # 取得單一活動
GET    /api/v1/activities/nearby       # 取得附近活動
POST   /api/v1/activities/search       # 進階搜尋

# 分類相關
GET    /api/v1/categories              # 取得所有分類
GET    /api/v1/categories/:slug        # 取得分類詳情

# 地區相關
GET    /api/v1/regions                 # 取得所有地區
GET    /api/v1/regions/:id/cities      # 取得地區內縣市

# 使用者相關
POST   /api/v1/auth/register           # 註冊
POST   /api/v1/auth/login              # 登入
GET    /api/v1/users/me                # 取得個人資料
GET    /api/v1/users/favorites         # 取得收藏列表
POST   /api/v1/users/favorites/:id     # 加入收藏
DELETE /api/v1/users/favorites/:id     # 移除收藏

# 驗證相關（內部使用）
POST   /api/v1/validation/submit       # 提交驗證
GET    /api/v1/validation/:id/status   # 查詢驗證狀態
```

### 4.2 API 請求/回應範例

```typescript
// 搜尋活動請求
POST /api/v1/activities/search
{
  "filters": {
    "categories": ["傳統節慶", "藝術文化"],
    "regions": ["北部地區"],
    "dateRange": {
      "start": "2025-02-01",
      "end": "2025-02-28"
    }
  },
  "location": {
    "lat": 25.0330,
    "lng": 121.5654,
    "radius": 10000  // 公尺
  },
  "sort": "distance",
  "pagination": {
    "page": 1,
    "limit": 20
  }
}

// 回應
{
  "success": true,
  "data": {
    "activities": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "name": "2025 台灣燈會",
        "location": {
          "address": "台北市信義區市府路1號",
          "distance": 2500
        },
        "time": {
          "start_date": "2025-02-01",
          "end_date": "2025-02-15"
        },
        "categories": ["傳統節慶", "藝術文化"],
        "summary": "全台最大規模燈會活動"
      }
    ],
    "pagination": {
      "total": 45,
      "page": 1,
      "pages": 3,
      "limit": 20
    }
  }
}
```

## 5. 開發環境設置

### 5.1 Docker Compose 配置

```yaml
version: '3.8'

services:
  # 前端開發服務器
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:4000
      - VITE_GOOGLE_MAPS_KEY=${GOOGLE_MAPS_KEY}

  # 後端 API 服務器
  backend:
    build: ./backend
    ports:
      - "4000:4000"
    volumes:
      - ./backend:/app
      - /app/node_modules
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/tourism
      - REDIS_URL=redis://redis:6379
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
    depends_on:
      - postgres
      - redis

  # PostgreSQL 資料庫
  postgres:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=tourism
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Redis 快取
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # 爬蟲服務
  crawler:
    build: ./crawler
    volumes:
      - ./crawler:/app
    environment:
      - API_URL=http://backend:4000
      - SCRAPY_SETTINGS_MODULE=crawler.settings
    depends_on:
      - backend

  # Claude 驗證服務
  validator:
    build: ./validator
    ports:
      - "5000:5000"
    environment:
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - DATABASE_URL=postgresql://user:pass@postgres:5432/tourism
    depends_on:
      - postgres

volumes:
  postgres_data:
  redis_data:
```

### 5.2 環境變數配置

```bash
# .env.example
# 資料庫
DATABASE_URL=postgresql://user:pass@localhost:5432/tourism
REDIS_URL=redis://localhost:6379

# API Keys
GOOGLE_MAPS_KEY=your_google_maps_key
CLAUDE_API_KEY=your_claude_api_key
GEOCODING_API_KEY=your_geocoding_key

# 應用配置
NODE_ENV=development
PORT=4000
FRONTEND_URL=http://localhost:3000

# JWT
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=7d

# 爬蟲配置
CRAWLER_USER_AGENT=TourismBot/1.0
CRAWLER_DELAY=1
CRAWLER_CONCURRENT_REQUESTS=3
```

## 6. CI/CD 配置

### 6.1 GitHub Actions 工作流程

```yaml
# .github/workflows/main.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci --prefix frontend
        npm ci --prefix backend
    
    - name: Run linting
      run: |
        npm run lint --prefix frontend
        npm run lint --prefix backend
    
    - name: Run tests
      run: |
        npm test --prefix frontend
        npm test --prefix backend
      env:
        DATABASE_URL: postgresql://postgres:testpass@localhost:5432/test
        REDIS_URL: redis://localhost:6379
    
    - name: Build
      run: |
        npm run build --prefix frontend
        npm run build --prefix backend

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to production
      run: |
        echo "Deploying to production..."
        # 實際部署指令
```

## 7. 安全性實作

### 7.1 API 安全措施

```typescript
// 速率限制
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 分鐘
  max: 100, // 限制 100 個請求
  message: '請求過於頻繁，請稍後再試'
});

// CORS 配置
const corsOptions = {
  origin: process.env.FRONTEND_URL,
  credentials: true,
  optionsSuccessStatus: 200
};

// 輸入驗證
import { body, validationResult } from 'express-validator';

const validateActivity = [
  body('name').isLength({ min: 2, max: 100 }).trim().escape(),
  body('location.address').isLength({ min: 5, max: 500 }),
  body('time.start_date').isISO8601(),
  body('categories').isArray().notEmpty()
];

// API Key 驗證（爬蟲使用）
const apiKeyAuth = (req, res, next) => {
  const apiKey = req.headers['x-api-key'];
  if (!apiKey || apiKey !== process.env.CRAWLER_API_KEY) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  next();
};
```

### 7.2 資料加密

```typescript
// 敏感資料加密
import crypto from 'crypto';

class Encryption {
  private algorithm = 'aes-256-gcm';
  private key: Buffer;
  
  constructor() {
    this.key = Buffer.from(process.env.ENCRYPTION_KEY, 'hex');
  }
  
  encrypt(text: string): string {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv(this.algorithm, this.key, iv);
    
    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    const authTag = cipher.getAuthTag();
    
    return iv.toString('hex') + ':' + authTag.toString('hex') + ':' + encrypted;
  }
  
  decrypt(encryptedData: string): string {
    const parts = encryptedData.split(':');
    const iv = Buffer.from(parts[0], 'hex');
    const authTag = Buffer.from(parts[1], 'hex');
    const encrypted = parts[2];
    
    const decipher = crypto.createDecipheriv(this.algorithm, this.key, iv);
    decipher.setAuthTag(authTag);
    
    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return decrypted;
  }
}
```

## 8. 效能優化實作

### 8.1 資料庫查詢優化

```typescript
// 使用 Prisma 的高效查詢
async function getNearbyActivities(lat: number, lng: number, radius: number) {
  // 使用 PostGIS 進行地理查詢
  const activities = await prisma.$queryRaw`
    SELECT 
      a.*,
      l.*,
      ST_Distance(
        ST_MakePoint(${lng}, ${lat})::geography,
        ST_MakePoint(l.longitude, l.latitude)::geography
      ) as distance
    FROM activities a
    JOIN locations l ON a.id = l.activity_id
    WHERE 
      a.status = 'active'
      AND ST_DWithin(
        ST_MakePoint(l.longitude, l.latitude)::geography,
        ST_MakePoint(${lng}, ${lat})::geography,
        ${radius}
      )
    ORDER BY distance
    LIMIT 50
  `;
  
  return activities;
}

// 批次載入關聯資料
async function getActivitiesWithDetails(ids: string[]) {
  return await prisma.activity.findMany({
    where: { id: { in: ids } },
    include: {
      location: true,
      time: true,
      categories: {
        include: {
          category: true
        }
      },
      source: true
    }
  });
}
```

### 8.2 快取策略

```typescript
// Redis 快取層
class CacheService {
  private redis: Redis;
  
  async getCachedData<T>(key: string, fetchFn: () => Promise<T>, ttl = 3600): Promise<T> {
    // 嘗試從快取取得
    const cached = await this.redis.get(key);
    if (cached) {
      return JSON.parse(cached);
    }
    
    // 快取未命中，執行查詢
    const data = await fetchFn();
    
    // 儲存至快取
    await this.redis.setex(key, ttl, JSON.stringify(data));
    
    return data;
  }
  
  async invalidatePattern(pattern: string): Promise<void> {
    const keys = await this.redis.keys(pattern);
    if (keys.length > 0) {
      await this.redis.del(...keys);
    }
  }
}
```

## 9. 監控與日誌

### 9.1 應用監控設置

```typescript
// Prometheus metrics
import { register, Counter, Histogram, Gauge } from 'prom-client';

const httpRequestDuration = new Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status']
});

const activeConnections = new Gauge({
  name: 'active_connections',
  help: 'Number of active connections'
});

const apiErrors = new Counter({
  name: 'api_errors_total',
  help: 'Total number of API errors',
  labelNames: ['endpoint', 'error_type']
});

// 日誌設置
import winston from 'winston';

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
});
```

## 10. 部署計畫

### 10.1 生產環境架構

```yaml
# kubernetes/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tourism-backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: tourism-backend
  template:
    metadata:
      labels:
        app: tourism-backend
    spec:
      containers:
      - name: backend
        image: tourism/backend:latest
        ports:
        - containerPort: 4000
        env:
        - name: NODE_ENV
          value: "production"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: tourism-secrets
              key: database-url
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
```

### 10.2 發布流程

1. **開發階段**
   - 功能開發在 feature 分支
   - 本地測試通過
   - 提交 Pull Request

2. **測試階段**
   - CI 自動執行測試
   - Code Review
   - 合併至 develop 分支

3. **預發布階段**
   - 部署至 staging 環境
   - 執行整合測試
   - UAT 測試

4. **正式發布**
   - 合併至 main 分支
   - 自動部署至生產環境
   - 監控系統狀態

這份技術實作計畫提供了完整的技術細節和實作指引，確保開發團隊能夠順利執行專案。