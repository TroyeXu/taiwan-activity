import{o as S,bs as E,r as g,M as N,bB as O,bC as R,q as i,ar as d,t as c,a7 as w,a3 as $,a0 as A,A as k,v as e,F as u,b4 as B,bm as F,E as T,ay as M,az as q}from"./CX06qJIc.js";const U=window.setInterval,V={key:0,class:"fixed bottom-4 right-4 z-50"},Q={class:"flex items-center space-x-3"},z={class:"flex-shrink-0"},j={class:"text-sm font-medium"},W={key:0,class:"text-xs opacity-75 mt-1"},J={key:0},G={key:1,class:"ml-2"},K=S({__name:"DatabaseStatus",props:{checkInterval:{},autoHide:{type:Boolean},autoHideDelay:{}},setup(C){const h=C,{checkDatabaseHealth:b,resetDatabase:_}=E(),r=g(null),s=g(!1);let a=null,o=null;const m={healthy:"bg-green-500 text-white",degraded:"bg-yellow-500 text-white",unhealthy:"bg-red-500 text-white"},n={healthy:"heroicons:check-circle-solid",degraded:"heroicons:exclamation-circle-solid",unhealthy:"heroicons:x-circle-solid"},v=async()=>{const p=await b();r.value=p,p.status!=="healthy"?(s.value=!0,o&&clearTimeout(o)):h.autoHide&&s.value&&(o=setTimeout(()=>{s.value=!1},h.autoHideDelay||3e3))},f=async()=>{try{await _(),await v()}catch(p){console.error("重試失敗:",p)}};return N(()=>{v(),h.checkInterval&&(a=U(v,h.checkInterval))}),O(()=>{a&&clearInterval(a),o&&clearTimeout(o)}),(p,D)=>{const x=R("Icon");return s.value?(c(),i("div",V,[w($,{name:"fade","enter-active-class":"transition ease-out duration-300","enter-from-class":"opacity-0 transform translate-y-2","enter-to-class":"opacity-100 transform translate-y-0","leave-active-class":"transition ease-in duration-200","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:A(()=>[r.value?(c(),i("div",{key:0,class:k(["px-4 py-3 rounded-lg shadow-lg",m[r.value.status]])},[e("div",Q,[e("div",z,[w(x,{name:n[r.value.status],class:"w-5 h-5"},null,8,["name"])]),e("div",null,[e("p",j,u(r.value.message),1),r.value.details?(c(),i("p",W,[r.value.details.queryTime?(c(),i("span",J," 查詢時間: "+u(r.value.details.queryTime)+"ms ",1)):d("",!0),r.value.details.errorCount?(c(),i("span",G," 錯誤次數: "+u(r.value.details.errorCount),1)):d("",!0)])):d("",!0)]),r.value.status!=="healthy"?(c(),i("button",{key:0,onClick:f,class:"ml-4 px-3 py-1 text-xs font-medium bg-white/20 hover:bg-white/30 rounded transition-colors"}," 重試 ")):d("",!0)])],2)):d("",!0)]),_:1})])):d("",!0)}}}),P=Object.assign(B(K,[["__scopeId","data-v-bfc4e022"]]),{__name:"DatabaseStatus"}),X={class:"container mx-auto p-8"},Y={class:"mb-8 p-6 bg-gray-100 rounded-lg"},Z={key:0,class:"space-y-2"},ee={class:"flex items-center space-x-2"},te={key:0,class:"mt-2 p-3 bg-white rounded"},se={class:"text-xs"},ae={class:"grid grid-cols-2 md:grid-cols-3 gap-4 mb-8"},le=["disabled"],oe=["disabled"],ne=["disabled"],ie=["disabled"],ce=["disabled"],re=["disabled"],ue={key:0,class:"mb-8"},de={class:"space-y-2 max-h-96 overflow-y-auto"},me={class:"flex items-center justify-between"},ve={class:"font-medium"},pe={class:"text-sm"},he={class:"text-sm mt-1"},ye={key:0,class:"text-xs mt-2 text-red-600"},ge={key:1,class:"p-4 bg-red-100 text-red-700 rounded"},_e=S({__name:"test-db",setup(C){const{checkHealth:h,query:b,resetDatabase:_}=F(),{loadActivities:r}=E(),s=g(!1),a=g(null),o=g(null),m=g([]),n=t=>{m.value.unshift(t),m.value.length>20&&m.value.pop()},v=async()=>{s.value=!0,a.value=null;try{const t=await h();o.value=t,n({test:"健康檢查",success:t.status==="healthy",message:t.message,timestamp:new Date})}catch(t){a.value=t.message,n({test:"健康檢查",success:!1,message:"健康檢查失敗",error:t.message,timestamp:new Date})}finally{s.value=!1}},f=async()=>{s.value=!0,a.value=null;try{const t=await b("SELECT COUNT(*) as count FROM activities");n({test:"正常查詢",success:!0,message:`查詢成功，活動數量: ${t[0]?.count||0}`,timestamp:new Date})}catch(t){a.value=t.message,n({test:"正常查詢",success:!1,message:"查詢失敗",error:t.message,timestamp:new Date})}finally{s.value=!1}},p=async()=>{s.value=!0,a.value=null;try{await b("SELECT * FROM non_existent_table"),n({test:"錯誤查詢",success:!1,message:"預期應該失敗但卻成功了",timestamp:new Date})}catch(t){n({test:"錯誤查詢",success:!0,message:"正確捕獲到錯誤",error:t.message,timestamp:new Date})}finally{s.value=!1}},D=async()=>{s.value=!0,a.value=null;try{await b(`
      WITH RECURSIVE cnt(x) AS (
        SELECT 1
        UNION ALL
        SELECT x+1 FROM cnt
        WHERE x<1000000
      )
      SELECT COUNT(*) FROM cnt
    `),n({test:"超時測試",success:!1,message:"查詢應該超時但完成了",timestamp:new Date})}catch(t){n({test:"超時測試",success:!0,message:"正確處理超時",error:t.message,timestamp:new Date})}finally{s.value=!1}},x=async()=>{s.value=!0,a.value=null;try{await _(),n({test:"重置資料庫",success:!0,message:"資料庫重置成功",timestamp:new Date}),await v()}catch(t){a.value=t.message,n({test:"重置資料庫",success:!1,message:"重置失敗",error:t.message,timestamp:new Date})}finally{s.value=!1}},I=async()=>{s.value=!0,a.value=null;try{await r(1,!0),n({test:"載入活動",success:!0,message:"活動載入成功",timestamp:new Date})}catch(t){a.value=t.message,n({test:"載入活動",success:!1,message:"載入失敗",error:t.message,timestamp:new Date})}finally{s.value=!1}};return v(),(t,l)=>{const L=P;return c(),i("div",X,[l[7]||(l[7]=e("h1",{class:"text-2xl font-bold mb-6"},"資料庫健康檢查測試",-1)),e("div",Y,[l[4]||(l[4]=e("h2",{class:"text-lg font-semibold mb-4"},"當前狀態",-1)),o.value?(c(),i("div",Z,[e("div",ee,[l[0]||(l[0]=e("span",{class:"font-medium"},"狀態:",-1)),e("span",{class:k(["px-3 py-1 rounded-full text-sm font-medium",o.value.status==="healthy"?"bg-green-500 text-white":o.value.status==="degraded"?"bg-yellow-500 text-white":"bg-red-500 text-white"])},u(o.value.status),3)]),e("p",null,[l[1]||(l[1]=e("span",{class:"font-medium"},"訊息:",-1)),T(" "+u(o.value.message),1)]),e("p",null,[l[2]||(l[2]=e("span",{class:"font-medium"},"時間:",-1)),T(" "+u(new Date(o.value.timestamp).toLocaleString()),1)]),o.value.details?(c(),i("div",te,[l[3]||(l[3]=e("p",{class:"text-sm font-medium mb-1"},"詳細資訊:",-1)),e("pre",se,u(JSON.stringify(o.value.details,null,2)),1)])):d("",!0)])):d("",!0)]),e("div",ae,[e("button",{onClick:v,disabled:s.value,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"}," 執行健康檢查 ",8,le),e("button",{onClick:f,disabled:s.value,class:"px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50"}," 測試正常查詢 ",8,oe),e("button",{onClick:p,disabled:s.value,class:"px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 disabled:opacity-50"}," 測試錯誤查詢 ",8,ne),e("button",{onClick:D,disabled:s.value,class:"px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 disabled:opacity-50"}," 測試超時 ",8,ie),e("button",{onClick:x,disabled:s.value,class:"px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 disabled:opacity-50"}," 重置資料庫 ",8,ce),e("button",{onClick:I,disabled:s.value,class:"px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 disabled:opacity-50"}," 測試載入活動 ",8,re)]),m.value.length>0?(c(),i("div",ue,[l[5]||(l[5]=e("h2",{class:"text-lg font-semibold mb-4"},"測試結果",-1)),e("div",de,[(c(!0),i(M,null,q(m.value,(y,H)=>(c(),i("div",{key:H,class:k(["p-3 rounded",y.success?"bg-green-100":"bg-red-100"])},[e("div",me,[e("span",ve,u(y.test),1),e("span",pe,u(new Date(y.timestamp).toLocaleTimeString()),1)]),e("p",he,u(y.message),1),y.error?(c(),i("pre",ye,u(y.error),1)):d("",!0)],2))),128))])])):d("",!0),a.value?(c(),i("div",ge,[l[6]||(l[6]=e("p",{class:"font-medium"},"錯誤:",-1)),e("p",null,u(a.value),1)])):d("",!0),w(L,{"check-interval":3e4,"auto-hide":!0,"auto-hide-delay":5e3})])}}});export{_e as default};
