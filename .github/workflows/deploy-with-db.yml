name: Deploy to GitHub Pages with Database

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Download database from release
        run: |
          echo "ğŸ“¥ ä¸‹è¼‰è³‡æ–™åº«æª”æ¡ˆ..."
          # å˜—è©¦å¾æœ€æ–°çš„ release ä¸‹è¼‰è³‡æ–™åº«
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name || echo "")
          
          if [ ! -z "$LATEST_RELEASE" ]; then
            echo "æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬: $LATEST_RELEASE"
            curl -L -o public/tourism.sqlite \
              "https://github.com/${{ github.repository }}/releases/download/$LATEST_RELEASE/tourism.sqlite" || true
          fi
          
          # å¦‚æœä¸‹è¼‰å¤±æ•—æˆ–æª”æ¡ˆä¸å­˜åœ¨ï¼Œå‰µå»ºç¤ºä¾‹è³‡æ–™åº«
          if [ ! -f public/tourism.sqlite ] || [ ! -s public/tourism.sqlite ]; then
            echo "âš ï¸ ç„¡æ³•ä¸‹è¼‰è³‡æ–™åº«ï¼Œå‰µå»ºç¤ºä¾‹è³‡æ–™åº«..."
            # å®‰è£ sqlite3
            sudo apt-get update && sudo apt-get install -y sqlite3
            
            # å‰µå»ºç¤ºä¾‹è³‡æ–™åº«
            sqlite3 public/tourism.sqlite << 'EOF'
            CREATE TABLE IF NOT EXISTS activities (
              id INTEGER PRIMARY KEY,
              name TEXT NOT NULL,
              description TEXT,
              address TEXT,
              latitude REAL,
              longitude REAL,
              category TEXT,
              tags TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            
            CREATE TABLE IF NOT EXISTS tags (
              id INTEGER PRIMARY KEY,
              name TEXT UNIQUE NOT NULL,
              usage_count INTEGER DEFAULT 0
            );
            
            INSERT INTO activities (name, description, address, latitude, longitude, category, tags)
            VALUES 
              ('å°åŒ— 101', 'å°ç£æœ€é«˜çš„å»ºç¯‰ç‰©', 'å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ', 25.0339, 121.5645, 'æ™¯é»', 'åœ°æ¨™,è³¼ç‰©'),
              ('æ•…å®®åšç‰©é™¢', 'ä¸–ç•Œç´šçš„åšç‰©é¤¨', 'å°åŒ—å¸‚å£«æ—å€è‡³å–„è·¯äºŒæ®µ221è™Ÿ', 25.1024, 121.5485, 'åšç‰©é¤¨', 'æ–‡åŒ–,æ­·å²'),
              ('æ—¥æœˆæ½­', 'å°ç£æœ€å¤§çš„å¤©ç„¶æ¹–æ³Š', 'å—æŠ•ç¸£é­šæ± é„‰', 23.8663, 120.9156, 'è‡ªç„¶æ™¯è§€', 'æ¹–æ³Š,é¢¨æ™¯');
            
            INSERT INTO tags (name, usage_count)
            VALUES ('åœ°æ¨™', 1), ('è³¼ç‰©', 1), ('æ–‡åŒ–', 1), ('æ­·å²', 1), ('æ¹–æ³Š', 1), ('é¢¨æ™¯', 1);
EOF
            echo "âœ… ç¤ºä¾‹è³‡æ–™åº«å‰µå»ºå®Œæˆ"
          fi
          
          # é©—è­‰è³‡æ–™åº«
          echo "ğŸ“Š è³‡æ–™åº«è³‡è¨Š:"
          ls -lh public/tourism.sqlite
          echo "è³‡æ–™è¡¨:"
          sqlite3 public/tourism.sqlite ".tables"
          echo "æ´»å‹•æ•¸é‡:"
          sqlite3 public/tourism.sqlite "SELECT COUNT(*) FROM activities;"

      - name: Build
        run: npm run generate

      - name: List output files
        run: |
          echo "=== Output directory structure ==="
          ls -la .output/public/
          echo "=== Check if tourism.sqlite exists ==="
          ls -lh .output/public/tourism.sqlite || echo "tourism.sqlite not found!"
          # é©—è­‰æª”æ¡ˆå…§å®¹
          if [ -f .output/public/tourism.sqlite ]; then
            echo "=== Verify SQLite file ==="
            file .output/public/tourism.sqlite
            head -c 16 .output/public/tourism.sqlite | od -c
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./.output/public
          force_orphan: true
          enable_jekyll: false
          keep_files: false